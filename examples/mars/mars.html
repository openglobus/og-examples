<html>

<head>
    <title>OpenGlobus - Mars planet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../external/og/lib/og.css" type="text/css"/>
</head>

<body>
<div id="globus" style="width:100%;height:100%;"></div>
<script type="module" id="og-sandbox-script">

    'use strict';

    import {
        Globe,
        XYZ,
        control,
        RgbTerrain,
        quadTreeStrategyType,
        mars,
        Vector,
        Entity,
        LonLat,
        scene
    } from "../../external/og/lib/og.es.js";

    const sat1 = new XYZ("Mars-Viking", {
        isBaseLayer: true,
        url: "https://terrain.openglobus.org/mars/sat/{z}/{x}/{y}.png",
        maxNativeZoom: 8,
    });

    const sat_arcgis = new XYZ("Mars-arcgis", {
        isBaseLayer: true,
        url: "https://astro.arcgis.com/arcgis/rest/services/OnMars/MDIM/MapServer/tile/{z}/{y}/{x}?blankTile=false",
    });

    var highResTerrain = new RgbTerrain("Mars", {
        geoidSrc: null,
        maxZoom: 8,
        maxNativeZoom: 8,
        url: "https://{s}.terrain.openglobus.org/mars/dem/{z}/{x}/{y}.png",
        heightFactor: 1.1
    });

    const mountains = new Vector("Mountains", {
        fading: true,
        minZoom: 4,
        scaleByDistance: [0, 6000000, 8000000],
    });

    const craters = new Vector("Craters", {
        fading: true,
        scaleByDistance: [0, 12000000, 25000000],
    });

    const vallis = new Vector("Valleys", {
        fading: true,
        scaleByDistance: [0, 12000000, 25000000],
    });

    let globe = new Globe({
        ellipsoid: mars,
        name: "mars",
        quadTreeStrategyPrototype: quadTreeStrategyType.equi,
        target: "globus",
        terrain: highResTerrain,
        layers: [sat1, sat_arcgis, mountains, craters, vallis],
        nightTextureSrc: null,
        specularTextureSrc: null,
        fontsSrc: "./fonts",
        atmosphereParameters: {
            ATMOS_HEIGHT: 60000.0,
            RAYLEIGH_SCALE: 0.18,
            MIE_SCALE: 0.08,
            GROUND_ALBEDO: 0.15,
            BOTTOM_RADIUS: 3389508.0 - 3000, // fix sea level
            EQUATORIAL_RADIUS: 3396200.0 - 3000, // fix sea level
            rayleighScatteringCoefficient_0: 1.0,
            rayleighScatteringCoefficient_1: 1.2,
            rayleighScatteringCoefficient_2: 1.4,
            mieScatteringCoefficient: 10.0,
            mieExtinctionCoefficient: 20.0,
            ozoneAbsorptionCoefficient_0: 0.10,
            ozoneAbsorptionCoefficient_1: 0.15,
            ozoneAbsorptionCoefficient_2: 0.80,
            ozoneDensityHeight: 10e3,
            ozoneDensityWide: 30e3,
            SUN_ANGULAR_RADIUS: 0.004685,
            SUN_INTENSITY: 1.0,
            disableSunDisk: false
        },
        skybox: new scene.SkyBox({
            px: "./px.webp",
            nx: "./nx.webp",
            py: "./py.webp",
            ny: "./ny.webp",
            pz: "./pz.webp",
            nz: "./nz.webp"
        }),
        atmosphereEnabled: true
    });

    globe.planet.addControls([new control.DebugInfo()]);
    globe.planet.addControls([new control.TimelineControl()]);
    globe.planet.addControls([new control.LayerSwitcher()]);

    fetch("./mountains.json").then((r) => r.json()).then((data) => {
        mountains.setEntities(data.features.map((f) => createLabelEntity(
                new LonLat(f.geometry.coordinates[0], f.geometry.coordinates[1]),
                f.properties.name,
                0,
                0,
                28,
                "Ephesis-Regular",
                30,
                true,
                "rgba(355,355,355,0.95)"
        )));
    });

    fetch("./craters.json").then((r) => r.json()).then((data) => {
        craters.setEntities(data.features.map((f) => createLabelEntity(
                new LonLat(f.geometry.coordinates[0], f.geometry.coordinates[1]),
                `${f.properties.name} ${f.properties.diameter_km} km`,
                0,
                0.12,
                0,
                "Karla-Italic",
                22,
                true,
                "rgb(355,303,244)"
                //"rgb(156,217,255)"
        )));
    });

    fetch("./vallis.json").then((r) => r.json()).then((data) => {
        vallis.setEntities(data.features.map((f) => createLabelEntity(
                new LonLat(f.geometry.coordinates[0], f.geometry.coordinates[1]),
                f.properties.name,
                0.2,
                0,
                35 + 3,
                "Karla-Light",
                38,
                false,
                "rgba(355,355,655,0.65)",
                15000
        )));
    });

    function createLabelEntity(
            lonlat,
            text,
            letterSpacing = 0,
            outline = 0,
            offsetY = 0,
            fontFace = "arial",
            fontSize = 18,
            showSpin = true,
            color = "white",
            forceHeight
    ) {
        const ell = globe.planet.ellipsoid;

        // Accept both longitude ranges: [-180..180] and [0..360]
        let lon = lonlat.lon;
        lon = lon > 180 ? ((lon + 180) % 360) - 180 : lon < -180 ? ((lon - 180) % 360) + 180 : lon;

        let ll = new LonLat(lon, lonlat.lat, forceHeight != undefined ? forceHeight : 12000);

        let res = new Entity({
            lonlat: ll,
            label: {
                size: fontSize,
                face: fontFace,
                letterSpacing: letterSpacing,
                outline: outline,
                outlineColor: "rgba(0,0,0,0.65)",
                text: text,
                align: "center",
                offset: [0, offsetY],
                color: color
            }
        });

        if (!forceHeight) {
            highResTerrain.getHeightAsync(ll, (h) => {
                ll.height = h + 8000;

                if (showSpin) {
                    res.appendChild(new Entity({
                        ray: {
                            startPosition: ell.lonLatToCartesian(new LonLat(ll.lon, ll.lat, h)),
                            endPosition: ell.lonLatToCartesian(ll),
                            startColor: "rgba(255,255,255,0.55)",
                            endColor: "rgba(255,255,255,0.0)",
                            thickness: 3
                        }
                    }));
                }

                res.setLonLat(ll);
            });
        }

        return res;
    }

</script>
</body>
</html>